'use client';

import { useState, useEffect, useRef } from 'react';
import { useRouter } from 'next/navigation';
import UsersTable from '@/components/admin/UsersTable';
import WalletsManager from '@/components/admin/WalletsManager';
import WithdrawalsManager from '@/components/admin/WithdrawalsManager';
import DepositsManager from '@/components/admin/DepositsManager';
import VipPackagesManager from '@/components/admin/VipPackagesManager';

type PageType = 'overview' | 'users' | 'wallets' | 'deposits' | 'withdrawals' | 'vip-packages';

export default function AdminDashboard() {
  const router = useRouter();
  const [currentPage, setCurrentPage] = useState<PageType>('overview');
  const [adminUser, setAdminUser] = useState<any>(null);
  const [soundEnabled, setSoundEnabled] = useState(false);
  const [audioContext, setAudioContext] = useState<AudioContext | null>(null);
  const [pendingStats, setPendingStats] = useState({ deposits: 0, withdrawals: 0 });
  const [totalUsers, setTotalUsers] = useState(0);
  
  const audioContextRef = useRef<AudioContext | null>(null);
  const lastUserCountRef = useRef<number>(0);
  const pendingStatsRef = useRef({ deposits: 0, withdrawals: 0 });
  
  useEffect(() => {
    audioContextRef.current = audioContext;
  }, [audioContext]);

  useEffect(() => {
    pendingStatsRef.current = pendingStats;
  }, [pendingStats]);

  useEffect(() => {
    // Auth kontrol√º
    const token = localStorage.getItem('adminToken');
    const user = localStorage.getItem('adminUser');
    
    if (!token || !user) {
      router.push('/admin/login');
      return;
    }

    setAdminUser(JSON.parse(user));
  }, [router]);

  // Separate effect for audio initialization
  useEffect(() => {
    // Auto-initialize audio if previously enabled
    const wasSoundEnabled = localStorage.getItem('adminSoundEnabled') === 'true';
    
    if (wasSoundEnabled && !audioContext) {
      console.log('üîÑ Sayfa yenilendi, ses sistemi otomatik ba≈ülatƒ±lƒ±yor...');
      
      // Tarayƒ±cƒ± etkile≈üimi gerektiriyorsa, butonu g√∂ster
      // Ama yine de arka planda ba≈ülatmayƒ± dene
      setTimeout(() => {
        try {
          const ctx = new (window.AudioContext || (window as any).webkitAudioContext)();
          setAudioContext(ctx);
          setSoundEnabled(true);
          console.log('‚úÖ Audio otomatik ba≈ülatƒ±ldƒ± (state:', ctx.state + ')');
          
          // Eƒüer suspended ise, kullanƒ±cƒ± etkile≈üimi gerekebilir
          if (ctx.state === 'suspended') {
            console.log('‚ö†Ô∏è AudioContext suspended durumunda. ƒ∞lk kullanƒ±cƒ± etkile≈üiminde aktif olacak.');
          }
        } catch (error) {
          console.error('‚ùå Auto audio initialization failed:', error);
        }
      }, 1000); // 1 saniye bekle, sayfa tam y√ºklensin
    } else if (!wasSoundEnabled) {
      console.log('‚ÑπÔ∏è Ses sistemi daha √∂nce etkinle≈ütirilmemi≈ü.');
    }
  }, []); // Sadece ilk mount'ta √ßalƒ±≈ü

  // Initialize audio context
  const initializeAudio = (showAlert = true) => {
    if (!audioContext) {
      console.log('üéµ Audio context olu≈üturuluyor...');
      const ctx = new (window.AudioContext || (window as any).webkitAudioContext)();
      setAudioContext(ctx);
      setSoundEnabled(true);
      
      localStorage.setItem('adminSoundEnabled', 'true');
      
      console.log('‚úÖ AudioContext olu≈üturuldu, state:', ctx.state);
      
      // Resume et
      if (ctx.state === 'suspended') {
        ctx.resume().then(() => {
          console.log('‚ñ∂Ô∏è AudioContext resume edildi!');
          playBeep(ctx);
        });
      } else {
        playBeep(ctx);
      }
      
      if (showAlert) {
        alert('üîî Global ses bildirimleri etkinle≈ütirildi!');
      }
    }
  };

  // Play beep sound (for pending requests)
  const playBeep = async (ctx?: AudioContext) => {
    try {
      const context = ctx || audioContextRef.current;
      if (!context) {
        console.error('‚ùå AudioContext bulunamadƒ±!');
        return;
      }

      // √ñNEMLI: AudioContext suspend olmu≈ü olabilir, √∂nce resume et!
      if (context.state === 'suspended') {
        console.log('‚è∏Ô∏è AudioContext suspended, resume ediliyor...');
        await context.resume();
        console.log('‚ñ∂Ô∏è AudioContext resumed!');
      }

      console.log('üîä BEEP sesi √ßalƒ±nƒ±yor... (state:', context.state + ')');

      const oscillator = context.createOscillator();
      const gainNode = context.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(context.destination);

      oscillator.frequency.value = 800;
      oscillator.type = 'sine';

      gainNode.gain.setValueAtTime(0.3, context.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.5);

      oscillator.start(context.currentTime);
      oscillator.stop(context.currentTime + 0.5);
      
      console.log('‚úÖ BEEP sesi √ßalƒ±ndƒ±!');
    } catch (e) {
      console.error('‚ùå Audio play failed:', e);
    }
  };

  // Play new user sound (happy melody - plays ONCE)
  const playNewUserSound = async (ctx?: AudioContext) => {
    try {
      const context = ctx || audioContextRef.current;
      if (!context) return;

      // √ñNEMLI: AudioContext suspend olmu≈ü olabilir, √∂nce resume et!
      if (context.state === 'suspended') {
        console.log('‚è∏Ô∏è AudioContext suspended, resume ediliyor...');
        await context.resume();
        console.log('‚ñ∂Ô∏è AudioContext resumed!');
      }

      console.log('üéâ Yeni √ºye melodisi √ßalƒ±nƒ±yor... (state:', context.state + ')');

      // Play a happy 3-note melody
      const notes = [523.25, 659.25, 783.99]; // C5, E5, G5 (Major chord)
      const noteDuration = 0.2;

      notes.forEach((frequency, index) => {
        const oscillator = context.createOscillator();
        const gainNode = context.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(context.destination);

        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';

        const startTime = context.currentTime + (index * noteDuration);
        gainNode.gain.setValueAtTime(0.4, startTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + noteDuration);

        oscillator.start(startTime);
        oscillator.stop(startTime + noteDuration);
      });

      console.log('üéâ Yeni √ºye sesi √ßalƒ±ndƒ±!');
    } catch (e) {
      console.error('New user sound failed:', e);
    }
  };

  // Check pending requests and new users
  const checkPendingRequests = async () => {
    const token = localStorage.getItem('adminToken');
    if (!token) return;

    try {
      const [depositsRes, withdrawalsRes, usersRes] = await Promise.all([
        fetch('/api/admin/deposits?status=all', {
          headers: { Authorization: `Bearer ${token}` },
        }),
        fetch('/api/admin/withdrawals?status=all', {
          headers: { Authorization: `Bearer ${token}` },
        }),
        fetch('/api/admin/users', {
          headers: { Authorization: `Bearer ${token}` },
        }),
      ]);

      const depositsData = await depositsRes.json();
      const withdrawalsData = await withdrawalsRes.json();
      const usersData = await usersRes.json();

      const newStats = {
        deposits: depositsData.stats?.pending || 0,
        withdrawals: withdrawalsData.stats?.pending || 0,
      };

      setPendingStats(newStats);

      // Check for new users
      const currentUserCount = usersData.stats?.totalUsers || 0;
      setTotalUsers(currentUserCount);

      // If user count increased, play new user sound ONCE
      if (lastUserCountRef.current > 0 && currentUserCount > lastUserCountRef.current) {
        const newUsersCount = currentUserCount - lastUserCountRef.current;
        console.log(`üéâ ${newUsersCount} yeni √ºye katƒ±ldƒ±! (${lastUserCountRef.current} ‚Üí ${currentUserCount})`);
        playNewUserSound();
      }

      // Update the last user count
      lastUserCountRef.current = currentUserCount;
    } catch (error) {
      console.error('Check pending error:', error);
    }
  };

  // Keep AudioContext alive with visibility change AND user interaction
  useEffect(() => {
    if (!audioContext) return;

    const handleVisibilityChange = async () => {
      if (document.visibilityState === 'visible' && audioContext.state === 'suspended') {
        console.log('üëÅÔ∏è Sekme aktif oldu, AudioContext resume ediliyor...');
        await audioContext.resume();
        console.log('‚ñ∂Ô∏è AudioContext aktif!');
      }
    };

    // Herhangi bir kullanƒ±cƒ± etkile≈üiminde resume et
    const handleUserInteraction = async () => {
      if (audioContext.state === 'suspended') {
        console.log('üëÜ Kullanƒ±cƒ± etkile≈üimi algƒ±landƒ±, AudioContext resume ediliyor...');
        await audioContext.resume();
        console.log('‚ñ∂Ô∏è AudioContext aktif!');
      }
    };

    document.addEventListener('visibilitychange', handleVisibilityChange);
    document.addEventListener('click', handleUserInteraction, { once: true });
    document.addEventListener('keydown', handleUserInteraction, { once: true });
    
    // Sayfa y√ºklendiƒüinde de resume etmeyi dene
    if (audioContext.state === 'suspended') {
      console.log('üîÑ Sayfa y√ºklendi, AudioContext resume ediliyor...');
      audioContext.resume().then(() => {
        console.log('‚ñ∂Ô∏è AudioContext ba≈ülatƒ±ldƒ±!');
      }).catch((err) => {
        console.log('‚ö†Ô∏è AudioContext resume edilemedi, kullanƒ±cƒ± etkile≈üimi gerekli:', err.message);
      });
    }
    
    return () => {
      document.removeEventListener('visibilitychange', handleVisibilityChange);
      document.removeEventListener('click', handleUserInteraction);
      document.removeEventListener('keydown', handleUserInteraction);
    };
  }, [audioContext]);

  // Global reminder system
  useEffect(() => {
    if (!soundEnabled || !audioContext) {
      console.log('‚è∏Ô∏è Ses sistemi hen√ºz hazƒ±r deƒüil:', { soundEnabled, audioContext: !!audioContext });
      return;
    }

    console.log('üéµ Global ses sistemi ba≈ülatƒ±ldƒ±!');

    // Initial check
    checkPendingRequests();

    // Check every 10 seconds
    const checkInterval = setInterval(() => {
      console.log('üîÑ API kontrol√º yapƒ±lƒ±yor...');
      checkPendingRequests();
    }, 10000);

    // Reminder sound every 20 seconds
    const reminderInterval = setInterval(() => {
      // √ñNEMLI: Ref kullan, state deƒüil! (Closure problemi √ß√∂z√ºm√º)
      const currentStats = pendingStatsRef.current;
      const totalPending = currentStats.deposits + currentStats.withdrawals;
      
      console.log('‚è∞ 20sn hatƒ±rlatma zamanƒ±! Kontrol ediliyor...', {
        deposits: currentStats.deposits,
        withdrawals: currentStats.withdrawals,
        total: totalPending,
        audioState: audioContextRef.current?.state
      });
      
      if (totalPending > 0) {
        console.log('üîî BEKLEYEN ƒ∞≈ûLEM VAR! Ses √ßalƒ±nƒ±yor...');
        playBeep();
      } else {
        console.log('‚úÖ Bekleyen i≈ülem yok, ses √ßalƒ±nmadƒ±');
      }
    }, 20000);

    return () => {
      console.log('üõë Global ses sistemi durduruldu');
      clearInterval(checkInterval);
      clearInterval(reminderInterval);
    };
  }, [soundEnabled, audioContext]);

  const handleLogout = () => {
    localStorage.removeItem('adminToken');
    localStorage.removeItem('adminUser');
    router.push('/admin/login');
  };

  if (!adminUser) {
    return (
      <div className="min-h-screen bg-slate-900 flex items-center justify-center">
        <div className="text-white text-xl">Y√ºkleniyor...</div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-900">
      {/* Top Bar */}
      <div className="bg-slate-800 border-b border-slate-700">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center h-16">
            <div className="flex items-center space-x-3">
              <div className="text-2xl">üéØ</div>
              <div>
                <h1 className="text-xl font-bold text-white">E-Corp Admin</h1>
                <p className="text-xs text-gray-400">{adminUser.email}</p>
              </div>
            </div>
            
            <div className="flex items-center space-x-4">
              {/* Global Sound Control */}
              {!soundEnabled && (
                <button
                  onClick={() => initializeAudio(true)}
                  className="px-3 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 text-sm animate-pulse flex items-center space-x-2"
                >
                  <span>üîî</span>
                  <span>Sesleri Etkinle≈ütir</span>
                </button>
              )}
              
              {soundEnabled && (
                <div className="flex items-center space-x-2">
                  <div className="flex items-center space-x-2 px-3 py-2 bg-green-600/20 text-green-400 rounded-lg border border-green-600">
                    <span>üîä</span>
                    <span className="text-sm">Global Ses Aktif</span>
                  </div>
                  {totalUsers > 0 && (
                    <div className="px-3 py-2 bg-blue-600/20 text-blue-400 rounded-lg border border-blue-600">
                      <span className="text-sm">
                        üë• {totalUsers} √úye
                      </span>
                    </div>
                  )}
                  {(pendingStats.deposits > 0 || pendingStats.withdrawals > 0) && (
                    <div className="px-3 py-2 bg-red-600/20 text-red-400 rounded-lg border border-red-600 animate-pulse">
                      <span className="text-sm font-bold">
                        {pendingStats.deposits + pendingStats.withdrawals} Bekleyen
                      </span>
                    </div>
                  )}
                </div>
              )}
              
              <button
                onClick={handleLogout}
                className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
              >
                √áƒ±kƒ±≈ü Yap
              </button>
            </div>
          </div>
        </div>
      </div>

      {/* Navigation Tabs */}
      <div className="bg-slate-800/50 border-b border-slate-700">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex space-x-1 overflow-x-auto">
            {[
              { id: 'overview', icon: 'üìä', label: 'Genel Bakƒ±≈ü' },
              { id: 'users', icon: 'üë•', label: 'Kullanƒ±cƒ±lar' },
              { id: 'vip-packages', icon: '‚≠ê', label: 'VIP Paketleri' },
              { id: 'wallets', icon: 'üí≥', label: 'C√ºzdanlar' },
              { id: 'deposits', icon: 'üí∞', label: 'Para Yatƒ±rma' },
              { id: 'withdrawals', icon: 'üí∏', label: 'Para √áekme' },
            ].map((tab) => (
              <button
                key={tab.id}
                onClick={() => setCurrentPage(tab.id as PageType)}
                className={`px-6 py-4 font-medium transition-colors border-b-2 whitespace-nowrap ${
                  currentPage === tab.id
                    ? 'text-purple-400 border-purple-400'
                    : 'text-gray-400 border-transparent hover:text-white'
                }`}
              >
                <span className="mr-2">{tab.icon}</span>
                {tab.label}
              </button>
            ))}
          </div>
        </div>
      </div>

      {/* Main Content */}
      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {currentPage === 'overview' && <OverviewPage />}
        {currentPage === 'users' && <UsersPage />}
        {currentPage === 'vip-packages' && <VipPackagesPage />}
        {currentPage === 'wallets' && <WalletsPage />}
        {currentPage === 'deposits' && <DepositsPage />}
        {currentPage === 'withdrawals' && <WithdrawalsPage />}
      </div>
    </div>
  );
}

// Overview Component
function OverviewPage() {
  const [stats, setStats] = useState<any>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchStats();
  }, []);

  const fetchStats = async () => {
    const token = localStorage.getItem('adminToken');
    
    try {
      const response = await fetch('/api/admin/users', {
        headers: { Authorization: `Bearer ${token}` },
      });
      const data = await response.json();
      setStats(data.stats);
    } catch (error) {
      console.error('Stats fetch error:', error);
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return <div className="text-white text-center">Y√ºkleniyor...</div>;
  }

  const cards = [
    { label: 'Toplam Kullanƒ±cƒ±', value: stats?.totalUsers || 0, icon: 'üë•', color: 'blue' },
    { label: 'Aktif Kullanƒ±cƒ±', value: stats?.activeUsers || 0, icon: '‚úÖ', color: 'green' },
    { label: 'VIP Kullanƒ±cƒ±', value: stats?.vipUsers || 0, icon: '‚≠ê', color: 'yellow' },
    { label: 'Toplam Bakiye', value: `$${stats?.totalBalance?.toFixed(2) || 0}`, icon: 'üí∞', color: 'purple' },
    { label: 'Toplam Yatƒ±rƒ±m', value: `$${stats?.totalDeposits?.toFixed(2) || 0}`, icon: 'üì•', color: 'green' },
    { label: 'Toplam √áekim', value: `$${stats?.totalWithdraws?.toFixed(2) || 0}`, icon: 'üì§', color: 'red' },
  ];

  return (
    <div className="space-y-6">
      <h2 className="text-2xl font-bold text-white">Genel Bakƒ±≈ü</h2>
      
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {cards.map((card, index) => (
          <div
            key={index}
            className="bg-slate-800 rounded-xl p-6 border border-slate-700 hover:border-slate-600 transition-colors"
          >
            <div className="flex items-center justify-between">
              <div>
                <p className="text-gray-400 text-sm mb-1">{card.label}</p>
                <p className="text-2xl font-bold text-white">{card.value}</p>
              </div>
              <div className="text-4xl">{card.icon}</div>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

// Users Component
function UsersPage() {
  return (
    <div className="space-y-6">
      <h2 className="text-2xl font-bold text-white">Kullanƒ±cƒ± Y√∂netimi</h2>
      <UsersTable />
    </div>
  );
}

function VipPackagesPage() {
  return <VipPackagesManager />;
}

function WalletsPage() {
  return <WalletsManager />;
}

function DepositsPage() {
  return (
    <div className="space-y-6">
      <h2 className="text-2xl font-bold text-white">Para Yatƒ±rma Talepleri</h2>
      <DepositsManager />
    </div>
  );
}

function WithdrawalsPage() {
  return (
    <div className="space-y-6">
      <h2 className="text-2xl font-bold text-white">Para √áekme Talepleri</h2>
      <WithdrawalsManager />
    </div>
  );
}

